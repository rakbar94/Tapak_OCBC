WITH user_stats AS (
    SELECT 
        a.username,
        a.email,
        r.tariff,
        COUNT(*) AS tariff_count,
        SUM(r.consumption) AS total_consumption,
        SUM(r.cost) AS total_cost,
        COUNT(*) AS total_readings
    FROM accounts a
    JOIN readings r ON a.id = r.account_id
    GROUP BY a.username, a.email, r.tariff
),
most_frequent AS (
    SELECT 
        username,
        email,
        tariff AS most_frequent_tariff,
        ROW_NUMBER() OVER (PARTITION BY username, email ORDER BY tariff_count DESC) AS rn,
        total_consumption,
        total_cost,
        total_readings
    FROM user_stats
)
SELECT
    username,
    email,
    most_frequent_tariff,
    SUM(total_consumption) AS total_consumption,
    ROUND(SUM(total_cost) * 1.0 / SUM(total_readings), 2) AS average_cost_per_reading
FROM most_frequent
WHERE rn = 1
GROUP BY username, email, most_frequent_tariff
ORDER BY username ASC;
